name: CI

on:
  pull_request:
    branches: [ main ]
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  test-scripts:
    name: Test Nushell Scripts
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Nushell
        uses: hustcer/setup-nu@v3
        with:
          version: '*'

      - name: Verify script syntax
        run: |
          echo "Checking Nushell script syntax..."
          find scripts -name "*.nu" -type f | while read -r script; do
            echo "Checking: $script"
            nu -c "nu-check $script" || exit 1
          done

      - name: Test script execution (dry run)
        run: |
          echo "Testing scripts can be loaded..."
          # Test that key scripts can at least be parsed
          nu -c "source scripts/lib/cli.nu" || exit 1
          echo "✅ Scripts validated"

  lint:
    name: Lint Scripts and Config
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Nushell
        uses: hustcer/setup-nu@v3
        with:
          version: '*'

      - name: Check script formatting
        run: |
          echo "Checking script formatting..."
          find scripts -name "*.nu" -type f | while read -r file; do
            if ! head -n 1 "$file" | grep -q "#!/usr/bin/env nu"; then
              echo "ERROR: Missing shebang in $file"
              exit 1
            fi
          done

      - name: Validate JSON files
        run: |
          echo "Validating JSON files..."
          find . -name "*.json" -type f -not -path "./.git/*" -not -path "./node_modules/*" | while read -r file; do
            echo "Validating: $file"
            jq empty "$file" || exit 1
          done

      - name: Check YAML syntax
        run: |
          echo "Checking YAML files..."
          find .github/workflows -name "*.yml" -o -name "*.yaml" | while read -r file; do
            echo "Checking: $file"
            # Basic YAML validation using Python
            python3 -c "import yaml; yaml.safe_load(open('$file'))" || exit 1
          done

  security:
    name: Security Checks
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Scan for secrets
        run: |
          echo "Scanning for potential secrets..."
          if grep -r -E "(password|secret|private[_-]?key)\s*=\s*['\"]" \
             --include="*.nu" \
             --include="*.sh" \
             --include="*.py" \
             --exclude-dir=".git" \
             --exclude-dir="docs" \
             . ; then
            echo "WARNING: Potential hardcoded secrets found"
            # Don't fail, just warn
          fi

      - name: Check file permissions
        run: |
          echo "Checking for overly permissive files..."
          find . -type f -perm -o+w -not -path "./.git/*" | while read -r file; do
            echo "WARNING: World-writable file: $file"
          done

  integration:
    name: Integration Tests
    runs-on: ubuntu-latest
    needs: [test-scripts, lint]
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Nushell
        uses: hustcer/setup-nu@v3
        with:
          version: '*'

      - name: Setup GitHub CLI
        run: |
          type gh || sudo apt-get update && sudo apt-get install -y gh

      - name: Run integration tests
        run: |
          echo "Running integration tests..."
          # These would be actual tests in a real scenario
          echo "✅ Integration tests passed (placeholder)"

  validate-justfile:
    name: Validate Justfile
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Just
        uses: extractions/setup-just@v2

      - name: Validate Justfile syntax
        run: just --summary

      - name: List available commands
        run: just --list

  summary:
    name: CI Summary
    runs-on: ubuntu-latest
    needs: [test-scripts, lint, security, integration, validate-justfile]
    if: always()
    steps:
      - name: Check job results
        run: |
          echo "CI Summary:"
          echo "  - Scripts: ${{ needs.test-scripts.result }}"
          echo "  - Lint: ${{ needs.lint.result }}"
          echo "  - Security: ${{ needs.security.result }}"
          echo "  - Integration: ${{ needs.integration.result }}"
          echo "  - Justfile: ${{ needs.validate-justfile.result }}"

          if [ "${{ needs.test-scripts.result }}" != "success" ] || \
             [ "${{ needs.lint.result }}" != "success" ] || \
             [ "${{ needs.security.result }}" != "success" ] || \
             [ "${{ needs.integration.result }}" != "success" ] || \
             [ "${{ needs.validate-justfile.result }}" != "success" ]; then
            echo "❌ Some checks failed"
            exit 1
          fi

          echo "✅ All CI checks passed!"
